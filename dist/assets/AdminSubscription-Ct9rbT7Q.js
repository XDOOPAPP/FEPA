import{j as e}from"./vendor-CIDEvgjn.js";import{r as i}from"./react-YvAU7kAw.js";import{d as n,e as s,f as r,g as t,h as l,i as a}from"./queries-BYgdP70j.js";import{I as d,_ as c,C as o,E as h,e as u,S as x,h as m,i as g,p as j,j as p,l as v,F as f,s as y,q as C,B as I,t as k,u as F,f as A,v as O,w as T,x as b,y as P,R as S}from"./antd-Ca0_LWAN.js";import{e as R,f as L}from"./index-DEkLrubD.js";import{R as N}from"./CloseCircleOutlined-BsKjmxrd.js";import"./subscriptionAPI-BwKWqfSG.js";import"./ocrAPI-D8COPIfY.js";import"./aiAPI-CydZBJ1Y.js";import"./socket-CUkmNz_4.js";var w={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M464 720a48 48 0 1096 0 48 48 0 10-96 0zm16-304v184c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V416c0-4.4-3.6-8-8-8h-48c-4.4 0-8 3.6-8 8zm475.7 440l-416-720c-6.2-10.7-16.9-16-27.7-16s-21.6 5.3-27.7 16l-416 720C56 877.4 71.4 904 96 904h832c24.6 0 40-26.6 27.7-48zm-783.5-27.9L512 239.9l339.8 588.2H172.2z"}}]},name:"warning",theme:"outlined"},H=function(e,n){return i.createElement(d,c({},e,{ref:n,icon:w}))},V=i.forwardRef(H);const E=()=>{const{data:s,isLoading:r,error:t}=n(),l=i.useMemo(()=>{if(!s)return{};const e=null==s?void 0:s.data;return e&&"object"==typeof e?e:s},[s]),a=Object.entries(l),d=a.reduce((e,[,i])=>e+((null==i?void 0:i.count)||0),0),c=a.length;return t?e.jsx(o,{style:{marginBottom:"24px"},children:e.jsx(h,{description:e.jsxs(u,{direction:"vertical",children:[e.jsx(V,{style:{fontSize:"32px",color:"#ff7a45"}}),e.jsx("span",{children:"Không thể tải thống kê"})]})})}):e.jsx(x,{spinning:r,indicator:e.jsx(v,{style:{fontSize:48}}),children:e.jsxs(o,{title:"Thống kê Subscription",style:{marginBottom:"24px"},children:[e.jsxs(m,{gutter:[16,16],children:[e.jsx(g,{xs:24,sm:12,md:6,children:e.jsx(o,{hoverable:!0,children:e.jsx(j,{title:"Subscription đang hoạt động",value:d,prefix:e.jsx(R,{}),valueStyle:{color:"#52c41a"}})})}),e.jsx(g,{xs:24,sm:12,md:6,children:e.jsx(o,{hoverable:!0,children:e.jsx(j,{title:"Số gói có thống kê",value:c,prefix:e.jsx(L,{}),valueStyle:{color:"#1890ff"}})})})]}),a.length>0?e.jsx(o,{title:"Số lượng subscription theo gói",style:{marginTop:"24px"},children:e.jsx(u,{wrap:!0,children:a.map(([i,n])=>e.jsxs(p,{color:"blue",style:{padding:"8px 12px",fontSize:"14px"},children:[e.jsxs("strong",{children:[(null==n?void 0:n.name)||"N/A",":"]})," ",(null==n?void 0:n.count)||0," subscription"]},i))})}):e.jsx(o,{style:{marginTop:"24px"},children:e.jsx(h,{description:"Chưa có dữ liệu subscription"})})]})})},M=()=>{const[n,d]=i.useState(!1),[c,h]=i.useState(null),[w,H]=i.useState(!1),[V]=f.useForm(),[M,B]=i.useState(null),[z,Y]=y.useMessage(),q=f.useWatch("isFree",V),{data:K,isLoading:G}=s(),{data:X}=r(),_=t(),D=l(),Q=a(),W=(K||[]).map(e=>({...e,id:e._id}));i.useEffect(()=>{var e,i,s,r;n&&(c?V.setFieldsValue({...c,isFree:c.isFree,"features.OCR":(null==(e=c.features)?void 0:e.OCR)||!1,"features.AI":(null==(i=c.features)?void 0:i.AI)||!1}):(V.resetFields(),V.setFieldsValue({isActive:!0,interval:"MONTHLY"}),M&&(V.setFieldsValue({...M,isFree:M.isFree||!1,"features.OCR":(null==(s=M.features)?void 0:s.OCR)||!1,"features.AI":(null==(r=M.features)?void 0:r.AI)||!1}),B(null))))},[n,c,V,M]);const $=[{title:"Tên gói",dataIndex:"name",key:"name",render:(i,n)=>e.jsxs(u,{children:[e.jsx("strong",{children:i}),n.isFree&&e.jsx(p,{color:"blue",children:"Free"})]})},{title:"Giá",dataIndex:"price",key:"price",render:e=>{return i=e,new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(i);var i},sorter:(e,i)=>e.price-i.price},{title:"Chu kỳ",dataIndex:"interval",key:"interval",render:e=>({MONTHLY:"Hàng tháng",YEARLY:"Hàng năm",LIFETIME:"Trọn đời"}[e])},{title:"Tính năng",key:"features",render:(i,n)=>{var s,r,t,l;return e.jsxs(u,{children:[(null==(s=n.features)?void 0:s.OCR)&&e.jsx(p,{color:"green",children:"OCR"}),(null==(r=n.features)?void 0:r.AI)&&e.jsx(p,{color:"purple",children:"AI"}),!(null==(t=n.features)?void 0:t.OCR)&&!(null==(l=n.features)?void 0:l.AI)&&e.jsx("span",{style:{color:"#ccc"},children:"Không có"})]})}},{title:"Trạng thái",dataIndex:"isActive",key:"isActive",render:(i,n)=>e.jsx(b,{checked:i,checkedChildren:"Hoạt động",unCheckedChildren:"Ngừng",loading:D.isPending&&(null==c?void 0:c.id)===n.id,onChange:e=>{D.mutate({planId:n.id,data:{isActive:e}})}}),filters:[{text:"Hoạt động",value:!0},{text:"Ngừng",value:!1}],onFilter:(e,i)=>i.isActive===e},{title:"Thao tác",key:"action",width:150,render:(i,n)=>e.jsxs(u,{children:[e.jsx(I,{type:"link",icon:e.jsx(P,{}),onClick:()=>(h(n),H(!1),void d(!0)),disabled:Q.isPending||_.isPending||D.isPending,children:"Sửa"}),e.jsx(I,{type:"link",danger:!0,icon:e.jsx(S,{}),onClick:()=>{return e=n.id,void F.confirm({title:"Xác nhận xóa",content:"Bạn có chắc chắn muốn xóa gói này?",okText:"Xóa",cancelText:"Hủy",okButtonProps:{danger:!0},onOk:async()=>{try{await Q.mutateAsync(e)}catch(i){}}});var e},disabled:Q.isPending||_.isPending||D.isPending,children:"Xóa"})]})}],J={totalPlans:W.length,activePlans:W.filter(e=>e.isActive).length},U=(null==X?void 0:X.success)??null,Z=_.isPending||D.isPending||Q.isPending;return e.jsx(x,{spinning:G,indicator:e.jsx(v,{style:{fontSize:48}}),children:e.jsxs("div",{style:{padding:"24px"},children:[Y,e.jsx("div",{style:{marginBottom:"16px"},children:e.jsxs(p,{color:U?"success":null===U?"processing":"error",icon:U?e.jsx(R,{}):null===U?e.jsx(v,{}):e.jsx(N,{}),children:["Subscription Service: ",U?"Online":null===U?"Checking...":"Offline"]})}),e.jsx(E,{}),e.jsxs(m,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(g,{xs:24,sm:8,md:6,children:e.jsx(o,{children:e.jsx(j,{title:"Tổng gói",value:J.totalPlans,prefix:e.jsx(L,{})})})}),e.jsx(g,{xs:24,sm:8,md:6,children:e.jsx(o,{children:e.jsx(j,{title:"Gói hoạt động",value:J.activePlans,prefix:e.jsx(R,{}),valueStyle:{color:"#52c41a"}})})})]}),e.jsx(o,{title:"Quản lý gói Premium",extra:e.jsxs(u,{children:[e.jsx(I,{onClick:()=>{W.some(e=>e.isFree)?z.warning("Chỉ được phép có 1 gói miễn phí!"):(h(null),H(!0),B({name:"Free",price:0,isActive:!0,interval:"LIFETIME",features:{OCR:!1,AI:!1},isFree:!0}),d(!0))},disabled:Z||W.some(e=>e.isFree),children:"Thêm gói miễn phí"}),e.jsx(I,{type:"primary",icon:e.jsx(k,{}),onClick:()=>{h(null),H(!1),B({isActive:!0,interval:"MONTHLY",isFree:!1,features:{OCR:!1,AI:!1}}),d(!0)},disabled:Z,children:"Thêm gói mới"})]}),style:{marginBottom:"24px"},children:e.jsx(C,{columns:$,dataSource:W.map(e=>({...e,key:e.id})),rowKey:"id",pagination:{pageSize:10},loading:G})}),e.jsx(F,{title:c?"Sửa gói Premium":w?"Thêm gói miễn phí mới":"Thêm gói Premium mới",open:n,onOk:async()=>{try{const e=await V.validateFields(),i={OCR:e["features.OCR"]||!1,AI:e["features.AI"]||!1},n=V.getFieldValue("isFree")||0===e.price;if(n){if(W.some(e=>e.isFree&&e.id!==(null==c?void 0:c.id)))return void z.error("Đã tồn tại gói miễn phí! Không thể tạo thêm.")}const{"features.OCR":s,"features.AI":r,...t}=e,l={...t,features:i};n&&(l.price=0,l.interval="LIFETIME"),c?(c.isFree?(delete l.isFree,delete l.isActive):l.isFree=l.isFree||!1,await D.mutateAsync({planId:c.id,data:l})):(l.isFree=n||!1,await _.mutateAsync(l)),d(!1),V.resetFields()}catch(e){}},onCancel:()=>{d(!1),V.resetFields()},width:600,destroyOnHidden:!0,forceRender:!0,okText:"Lưu",cancelText:"Hủy",confirmLoading:Z,children:e.jsxs(f,{form:V,layout:"vertical",children:[e.jsx(f.Item,{name:"name",label:"Tên gói",rules:[{required:!0,message:"Vui lòng nhập tên gói"}],children:e.jsx(A,{placeholder:"Ví dụ: Premium, Basic..."})}),e.jsx(f.Item,{name:"isFree",hidden:!0,initialValue:!1,children:e.jsx(A,{type:"hidden"})}),e.jsxs(m,{gutter:16,children:[e.jsx(g,{span:12,children:e.jsx(f.Item,{name:"price",label:"Giá (VNĐ)",rules:[{required:!0,message:"Vui lòng nhập giá"}],children:e.jsx(O,{style:{width:"100%"},min:0,formatter:e=>`${e}`.replace(/\B(?=(\d{3})+(?!\d))/g,","),placeholder:"99000",disabled:!0===q})})}),e.jsx(g,{span:12,children:e.jsx(f.Item,{name:"interval",label:"Chu kỳ",rules:[{required:!0,message:"Vui lòng chọn chu kỳ"}],initialValue:"MONTHLY",children:e.jsxs(T,{style:{width:"100%"},disabled:!0===q,children:[e.jsx(T.Option,{value:"MONTHLY",children:"Hàng tháng"}),e.jsx(T.Option,{value:"YEARLY",children:"Hàng năm"}),e.jsx(T.Option,{value:"LIFETIME",children:"Trọn đời"})]})})})]}),e.jsx(f.Item,{label:"Tính năng",children:e.jsxs(m,{children:[e.jsxs(g,{span:12,children:[e.jsx(f.Item,{name:"features.OCR",valuePropName:"checked",noStyle:!0,children:e.jsx(b,{checkedChildren:"OCR",unCheckedChildren:"OCR"})}),e.jsx("span",{style:{marginLeft:8},children:"Nhận diện văn bản (OCR)"})]}),e.jsxs(g,{span:12,children:[e.jsx(f.Item,{name:"features.AI",valuePropName:"checked",noStyle:!0,children:e.jsx(b,{checkedChildren:"AI",unCheckedChildren:"AI"})}),e.jsx("span",{style:{marginLeft:8},children:"Phân tích AI"})]})]})}),e.jsx(f.Item,{name:"isActive",label:"Trạng thái",valuePropName:"checked",initialValue:!0,children:e.jsx(b,{checkedChildren:"Hoạt động",unCheckedChildren:"Ngừng"})})]})})]})})};export{M as default};
