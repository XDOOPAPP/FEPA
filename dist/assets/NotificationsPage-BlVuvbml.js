import{j as e}from"./vendor-CIDEvgjn.js";import{r as i,u as n}from"./react-YvAU7kAw.js";import{n as a,u as s,k as t,l,e as o,N as r}from"./index-DEkLrubD.js";import{F as c,T as d,B as h,K as g,f as m,w as u,N as x,s as j,e as p,t as v,O as N,R as T,P as y,E as b,S,Q as E}from"./antd-Ca0_LWAN.js";import"./socket-CUkmNz_4.js";const{TextArea:_}=m,{Title:f}=d,A=[{value:"INFO",label:"Thông tin chung"},{value:"SYSTEM_MAINTENANCE",label:"Bảo trì hệ thống"},{value:"FEATURE_UPDATE",label:"Cập nhật tính năng"},{value:"URGENT",label:"Khẩn cấp"},{value:"ANNOUNCEMENT",label:"Thông báo quan trọng"}],C=({visible:n,onClose:s,onSuccess:t})=>{const[l]=c.useForm(),[o,r]=i.useState(!1),[d,p]=i.useState(0),[v,N]=i.useState(0);return n?e.jsx("div",{className:"create-notification-modal",onClick:s,children:e.jsxs("div",{className:"create-notification-modal__content",onClick:e=>e.stopPropagation(),children:[e.jsxs("div",{className:"create-notification-modal__header",children:[e.jsx(f,{level:4,style:{margin:0},children:"Tạo Thông Báo Mới"}),e.jsx(h,{type:"text",icon:e.jsx(g,{}),onClick:s,disabled:o})]}),e.jsxs(c,{form:l,layout:"vertical",onFinish:async e=>{try{r(!0),await a.createNotification({title:e.title,message:e.message,type:e.type||"INFO",target:e.target}),j.success("Thông báo đã được gửi thành công!"),l.resetFields(),p(0),N(0),null==t||t(),s()}catch(i){j.error((null==i?void 0:i.message)||"Gửi thông báo thất bại. Vui lòng thử lại.")}finally{r(!1)}},initialValues:{type:"INFO",target:"ALL"},children:[e.jsx(c.Item,{label:"Tiêu đề",name:"title",rules:[{required:!0,message:"Vui lòng nhập tiêu đề"},{min:5,message:"Tiêu đề phải có ít nhất 5 ký tự"},{max:100,message:"Tiêu đề không được quá 100 ký tự"}],children:e.jsx(m,{placeholder:"Thông báo bảo trì hệ thống",maxLength:100,onChange:e=>p(e.target.value.length)})}),e.jsxs("div",{className:"create-notification-modal__char-count",children:[d,"/100"]}),e.jsx(c.Item,{label:"Nội dung",name:"message",rules:[{required:!0,message:"Vui lòng nhập nội dung"},{min:10,message:"Nội dung phải có ít nhất 10 ký tự"},{max:500,message:"Nội dung không được quá 500 ký tự"}],children:e.jsx(_,{placeholder:"Hệ thống sẽ bảo trì từ 22h-24h hôm nay. Vui lòng lưu công việc.",rows:4,maxLength:500,onChange:e=>N(e.target.value.length)})}),e.jsxs("div",{className:"create-notification-modal__char-count",children:[v,"/500"]}),e.jsx(c.Item,{label:"Loại thông báo",name:"type",children:e.jsx(u,{options:A})}),e.jsx(c.Item,{label:"Gửi đến",name:"target",rules:[{required:!0,message:"Vui lòng chọn đối tượng nhận"}],children:e.jsxs(x.Group,{children:[e.jsx(x,{value:"ALL",children:"Tất cả người dùng (ALL)"}),e.jsx(x,{value:"ADMINS",children:"Chỉ Admin (ADMINS)"})]})}),e.jsxs("div",{className:"create-notification-modal__footer",children:[e.jsx(h,{onClick:s,disabled:o,children:"Hủy"}),e.jsx(h,{type:"primary",htmlType:"submit",loading:o,children:"Gửi Thông Báo"})]})]})]})}):null},{Title:k,Paragraph:I}=d,M=[{label:"Tất cả",value:"all"},{label:"Chưa đọc",value:"unread"},{label:"Đã đọc",value:"read"}],L=()=>{const a=n(),{user:c}=s(),[d,g]=i.useState("all"),[u,x]=i.useState(1),[j,_]=i.useState(10),[f,A]=i.useState(""),[L,P]=i.useState(!1),{markAsRead:R,markAllAsRead:F,deleteOne:D,deleteAll:B}=t(),O=i.useMemo(()=>{const e={page:u,limit:j};return"unread"===d&&(e.unreadOnly=!0),f.trim()&&(e.search=f.trim()),e},[d,u,j,f]),{data:G,isLoading:q,isFetching:w,refetch:U,error:V}=l(O),K=(null==G?void 0:G.notifications)||[],z=i.useMemo(()=>"read"===d?K.filter(e=>e.isRead):K,[K,d]),Y=null==G?void 0:G.pagination,H=e=>{switch(e.type){case"PAYMENT_FAILED":case"PAYMENT_SUCCESS":case"SUBSCRIPTION_EXPIRED":a("/admin/subscription")}},X="ADMIN"===(null==c?void 0:c.role);return e.jsxs("div",{className:"notifications-page",children:[e.jsxs("div",{className:"notifications-page__header",children:[e.jsxs("div",{children:[e.jsx(k,{level:3,style:{marginBottom:4},children:"Thông báo"}),e.jsx(I,{type:"secondary",style:{marginBottom:0},children:"Theo dõi các sự kiện hệ thống và nội dung cần xử lý"})]}),e.jsxs(p,{children:[X&&e.jsx(h,{type:"primary",icon:e.jsx(v,{}),onClick:()=>P(!0),children:"Tạo Thông Báo"}),e.jsx(h,{icon:e.jsx(N,{}),onClick:()=>U(),loading:w,children:"Làm mới"}),e.jsx(h,{icon:e.jsx(o,{}),onClick:()=>F.mutate(),loading:F.isPending,children:"Đánh dấu tất cả đã đọc"}),e.jsx(h,{icon:e.jsx(T,{}),danger:!0,onClick:()=>B.mutate(),loading:B.isPending,children:"Xóa tất cả"})]})]}),e.jsxs("div",{className:"notifications-page__toolbar",children:[e.jsx(y,{options:M,value:d,onChange:e=>{g(e),x(1)}}),e.jsx(m.Search,{placeholder:"Tìm kiếm tiêu đề hoặc nội dung",allowClear:!0,onSearch:e=>{A(e),x(1)},style:{maxWidth:320}})]}),e.jsx("div",{className:"notifications-page__list",children:V?e.jsx("div",{style:{padding:48},children:e.jsx(b,{description:e.jsxs("div",{children:[e.jsx("p",{children:"Không thể tải thông báo"}),e.jsx("p",{style:{color:"#999",fontSize:12},children:(null==V?void 0:V.message)||"Đã xảy ra lỗi khi tải dữ liệu"}),e.jsx(h,{type:"primary",onClick:()=>U(),style:{marginTop:12},children:"Thử lại"})]}),image:b.PRESENTED_IMAGE_SIMPLE})}):q?e.jsx("div",{style:{padding:32,textAlign:"center"},children:e.jsx(S,{})}):0===z.length?e.jsx("div",{style:{padding:48},children:e.jsx(b,{description:"Không có thông báo",image:b.PRESENTED_IMAGE_SIMPLE})}):z.map(i=>e.jsx(r,{notification:i,onMarkAsRead:e=>R.mutate(e),onDelete:e=>D.mutate(e),onNavigate:H},i._id))}),e.jsx("div",{style:{marginTop:16,textAlign:"right"},children:e.jsx(E,{current:u,pageSize:j,total:(null==Y?void 0:Y.total)||0,showSizeChanger:!0,onChange:(e,i)=>{x(e),_(i)}})}),e.jsx(C,{visible:L,onClose:()=>P(!1),onSuccess:()=>{U()}})]})};export{L as default};
